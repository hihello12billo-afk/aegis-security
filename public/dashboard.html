<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | Aegis Security</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <nav>
        <div class="logo">AEGIS<span class="highlight">.DASH</span></div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
    </nav>

    <div class="dashboard-grid">
        <aside class="sidebar">
            <h3 id="user-welcome">Welcome</h3>
            <ul>
                <li class="active">Overview</li>
                <li>Active Protections</li>
                <li>Billing & Orders</li>
                <li>Support Tickets</li>
            </ul>
        </aside>

        <main>
            <h2>Security Overview</h2>
            <div class="grid-3" style="margin-top: 1rem; margin-bottom: 2rem;">
                <div class="card">
                    <h3>Status</h3>
                    <p style="color: #00ff88;">‚óè Protected</p>
                </div>
                <div class="card">
                    <h3>Threats Blocked</h3>
                    <p class="highlight" style="font-size: 2rem;">0</p>
                </div>
            </div>

            <h2>Recent Orders</h2>
            <div id="order-list">Loading orders...</div>
            
            <div id="cart-section" style="margin-top: 3rem;">
                <h2>Your Cart</h2>
                <div id="cart-items" style="margin-bottom: 1rem; color: var(--text-muted);">Cart is empty</div>
                <button onclick="checkout()" class="cta-btn primary">Secure Checkout via Stripe</button>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Load User Name
        document.getElementById('user-welcome').innerText = `User: ${localStorage.getItem('username') || 'Client'}`;

        // Render Cart
        const cartContainer = document.getElementById('cart-items');
        if(cart.length > 0) {
            cartContainer.innerHTML = cart.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span>${item.title} (x${item.quantity})</span>
                    <span>$${item.price * item.quantity}</span>
                </div>
            `).join('');
        }

        // Fetch Orders
        async function fetchOrders() {
            const token = localStorage.getItem('token');
            const res = await fetch('/api/my-orders', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const orders = await res.json();
            
            const orderList = document.getElementById('order-list');
            if(orders.length === 0) {
                orderList.innerHTML = '<p style="color: grey;">No past orders found.</p>';
                return;
            }

            orderList.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Date</th><th>Items</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody>
                        ${orders.map(o => `
                            <tr>
                                <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                                <td>${o.items.length} items</td>
                                <td>$${o.total}</td>
                                <td>${o.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        fetchOrders();
    </script>
</body>
</html>